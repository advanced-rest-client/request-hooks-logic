<!doctype html>
<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <link rel="import" href="../request-hooks-logic.html">
    <link rel="import" href="../../arc-polyfills/arc-polyfills.html">
  </head>
  <body>
    <script>
    /* global assert, JsonExtractor */
    suite('Extracts paths', function() {
      const json = `
      {
        "items": [{
          "id": "id1",
          "name": {
            "first": "Test"
          }
        }, {
          "id": "id2",
          "name": {
            "first": "Brown"
          }
        }],
        "nextPageToken": "testToken",
        "deep": {
          "object": {
            "value": "true"
          }
        }
      }
      `;
      var extractor;
      test('Reads first level value', function() {
        extractor = new JsonExtractor(json, 'nextPageToken');
        const result = extractor.extract();
        assert.equal(result, 'testToken');
      });

      test('Reads deep object value', function() {
        extractor = new JsonExtractor(json, 'deep.object.value');
        const result = extractor.extract();
        assert.equal(result, 'true');
      });

      test('Reads array value', function() {
        extractor = new JsonExtractor(json, 'items.1.id');
        const result = extractor.extract();
        assert.equal(result, 'id2');
      });

      test('Reads array deep value', function() {
        extractor = new JsonExtractor(json, 'items.1.name.first');
        const result = extractor.extract();
        assert.equal(result, 'Brown');
      });

      test('Returns undefined for unknown path', function() {
        extractor = new JsonExtractor(json, 'items.2.name.first');
        const result = extractor.extract();
        assert.isUndefined(result);
      });

      test('Returns undefined for unknown json', function() {
        extractor = new JsonExtractor(undefined, 'items.2.name.first');
        const result = extractor.extract();
        assert.isUndefined(result, 'Brown');
      });
    });

    suite('Array JSON', function() {
      const json = [{
        id: 'id1',
        name: {
          first: 'Test',
          last: 'Name'
        }
      }, {
        id: 'id2',
        name: {
          first: 'Brown',
          last: 'test2'
        }
      }];
      var extractor;
      test('Reads array value without iterator', function() {
        extractor = new JsonExtractor(json, '0.id');
        const result = extractor.extract();
        assert.equal(result, 'id1');
      });

      test('Reads deep array value without iterator', function() {
        extractor = new JsonExtractor(json, '0.name.first');
        const result = extractor.extract();
        assert.equal(result, 'Test');
      });
    });

    suite('Iterators', function() {
      suite('Object value', function() {
        const json = `
        {
          "items": [{
            "id": "id1",
            "name": {
              "first": "Test",
              "last": "Last test"
            }
          }, {
            "id": "id2",
            "name": {
              "first": "Adam",
              "last": "Brown"
            }
          }]
        }
        `;
        const iterator = {
          source: 'items.*.name.last',
          operator: 'equal',
          condition: 'Brown'
        };
        var extractor;
        test('Reads iterable value', function() {
          extractor = new JsonExtractor(json, 'id', iterator);
          const result = extractor.extract();
          assert.equal(result, 'id2');
        });

        test('Reads iterable deep value', function() {
          extractor = new JsonExtractor(json, 'name.first', iterator);
          const result = extractor.extract();
          assert.equal(result, 'Adam');
        });
      });

      suite('Array value', function() {
        const json = [{
          id: 'id1',
          name: {
            first: 'Test',
            last: 'Name'
          }
        }, {
          id: 'id2',
          name: {
            first: 'Brown',
            last: 'test2'
          }
        }];
        const iterator = {
          source: '*.name.first',
          operator: 'equal',
          condition: 'Brown'
        };
        var extractor;
        test('Reads simple path value', function() {
          extractor = new JsonExtractor(json, 'id', iterator);
          const result = extractor.extract();
          assert.equal(result, 'id2');
        });

        test('Reads deep path value', function() {
          extractor = new JsonExtractor(json, 'name.last', iterator);
          const result = extractor.extract();
          assert.equal(result, 'test2');
        });
      });

      suite('Iteration over objects', function() {
        const json = {
          id: 'id1',
          properties: {
            first: 'Test',
            last: 'Name',
            id: 'testid'
          },
          deep: {
            value: {
              properties: {
                first: 'Test',
                last: 'Name',
                id: 'testid2'
              }
            }
          }
        };
        const iterator = {
          source: 'properties.*.first',
          operator: 'equal',
          condition: 'Test'
        };
        var extractor;
        test('Reads simple path value', function() {
          extractor = new JsonExtractor(json, 'id', iterator);
          const result = extractor.extract();
          assert.equal(result, 'testid');
        });

        test('Reads simple path value', function() {
          iterator.source = 'deep.value.properties.*.first';
          extractor = new JsonExtractor(json, 'id', iterator);
          const result = extractor.extract();
          assert.equal(result, 'testid2');
        });
      });
    });
    </script>
  </body>
</html>
